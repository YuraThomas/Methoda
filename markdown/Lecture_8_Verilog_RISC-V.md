# Лекция 8. RISC-V на Verilog

**Введение**

На самом деле, изначально не планировалось разбивать статью про RISC-V на 3(4, если считать декодер) лекции, но после того, как автор увидел примерное число страниц, которое выходит на описание данной темы (порядка 20-30), то было принято решение разделить лекция на несколько частей: архитектурную, декодер , реализацию архитектурной части на Verilog (то есть, в данной статье большая часть содержания – скрины кода и тесты получившегося устройства с некоторыми пояснениями) и прошивка (которая выполняет роль тестирования операций регистр/регистр, регистр/константа и условных переходов) (следующая статья) устройства

**АЛУ к RISC-V.**

АЛУ к данному процессору было реализовано в статье 1 про АЛУ (АЛУ под номером 3), но я напомню некоторые моменты оттуда.

<img src="./media/image23.png" style="width:5.01745in;height:1.2in" />

Для выхода АЛУ (у нас вместо result_0 выход Out_ALU

<img src="./media/image24.png" style="width:4.80553in;height:2.125in" />

Роль флага сравнения у нас будет играть бит C

<img src="./media/image25.png" style="width:3.79687in;height:1.40165in" />

**Описание АЛУ(есть недочеты небольшие, исправленное АЛУ на гитхабе).**

<img src="./media/image27.png" style="width:3.6in;height:9.68in" />

<img src="./media/image28.png" style="width:1.88333in;height:1.25556in" />

<img src="./media/image29.png" style="width:2in;height:1.15511in" />

<img src="./media/image30.png" style="width:2.15833in;height:1.15229in" />

**Data Memory**

<img src="./media/image150.png" style="width:1.27083in;height:1.54561in" />

Данная штуковина практически полностью аналогична регистровому файлу кроме управляющих битов.

<img src="./media/image132.png" style="width:6.49653in;height:1.53158in" />

То есть, залезаем в код для регистрового файла, ставим там пару-тройку мультиплексоров для реализации memi и получаем в итоге Data Memory.

**RTL схема Data Memory**

<img src="./media/image151.png" style="width:6.96528in;height:1.63889in" />

**Описание Data Memory на Verilog.**

<img src="./media/image152.png" style="width:4.22222in;height:4.49729in" />

**Небольшое тестирование Data Memory**

<img src="./media/image153.png" style="width:6.49306in;height:0.92361in" />

<img src="./media/image154.png" style="width:6.49306in;height:0.93056in" />

**Декодер инструкций. Затычку надо поставить 32’d0 (иначе будет веселая константа)**

<img src="./media/image149.png" style="width:4.34722in;height:9.75043in" />

**Счетчик**

Я решил вывести его в отдельный модуль, так-как счетчик практически не связан с остальным процессором (не считая выходы декодера) и занимает довольно много места в коде, что делает его не очень хорошо читаемым.

**Схема счетчика, которую будем описывать на Verilog.**

<img src="./media/image155.png" style="width:1.83333in;height:1.63352in" />

**Описание на Verilog**

<img src="./media/image156.png" style="width:3.59563in;height:3.57143in" />

**Схема, которая синтезировалась**

<img src="./media/image157.png" style="width:6.48819in;height:1.75in" />

Итак, мы реализовали декодер, счетчик, регистровый файл (уж его я не стал дублировать тут), АЛУ, Data Memory и память команд, осталось просто соединить все проводами (и добавить пару-тройку знаковых расширителей и мультиплексоров).

**Схема RISC-V концептуальная**

<img src="./media/image158.png" style="width:4.99167in;height:2.26741in" />

**RTL схема RISC-V (что по описанию на Verilog синтезировалось).**

<img src="./media/image159.png" style="width:7.97275in;height:3.03333in" />

Как читатель может видеть, out_proc ни к чему не подключен, но так и должно быть, так-как данный выход я планирую использовать для тестирования прошивки RISC-V.

В общем-то и все, процессор готов, осталось его протестировать (описание на Verilog будет на следующей страничке). Однако, как писалось выше, автор будет придерживаться “тестированием прошивкой”, где мы будем прошивать RISC-V, и если он на наших примерах работает, то и хорошо (такой поиск тривиальных ошибок), чем мы и займемся в следующей статье.

Как читатель может видеть, простейший однотактный RISC-V весьма прост (да, тавтология) и занимает порядка 135(ядро)+100(АЛУ)+15(command_memory)+45(data memory)+135(декодер)+26(регистровый файл)+38(модули к АЛУ) = 464 строчек кода (порядка 500), что весьма подъемно для реализации за недельки так 2 с чашечкой чая (гикам можно меньше, разрешаю).**  
**

**Описание на Verilog RISC-V (код есть на гитхабе).**

<img src="./media/image160.png" style="width:3.60826in;height:9.56944in" />
